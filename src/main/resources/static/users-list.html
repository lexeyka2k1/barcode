<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотр пользователей - OPAC-Global</title>
    <link rel="stylesheet" href="styles.css" id="main-style">
    <link rel="stylesheet" href="light-styles.css" id="light-theme" disabled>
    <link rel="stylesheet" href="grayscale.css" id="grayscale-style" disabled>
    <link rel="stylesheet" href="high-contrast.css" id="high-contrast-style" disabled>
</head>
<body>
<div class="container">
    <nav class="sidebar" id="sidebar">
        <ul class="menu">
            <!-- Меню будет заполнено через JavaScript -->
        </ul>
    </nav>

    <button class="menu-button" onclick="toggleMenu()">☰</button>

    <main class="content">
        <div class="header">
            <h1>Просмотр всех пользователей</h1>
            <p>Список зарегистрированных пользователей системы</p>
        </div>

        <div class="users-table-container">
            <table class="users-table">
                <thead>
                <tr>
                    <th>№</th>
                    <th>ID</th>
                    <th>Наименование</th>
                    <th>Логин</th>
                    <th>Пароль</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody id="users-table-body">
                <!-- Данные будут загружаться динамически -->
                </tbody>
            </table>

            <div class="table-actions">
                <button onclick="window.location.href='registration.html'">Добавить пользователя</button>
            </div>
        </div>
    </main>
</div>

<!-- Модальное окно подтверждения -->
<div class="modal-overlay" id="confirm-modal">
    <div class="modal-content">
        <h3 class="modal-title" id="modal-title">Подтверждение удаления</h3>
        <p class="modal-message" id="modal-message"></p>
        <div class="modal-actions">
            <button class="modal-button secondary" id="cancel-delete">Отмена</button>
            <button class="modal-button primary" id="confirm-delete">Удалить</button>
        </div>
    </div>
</div>

<script src="menu.js"></script>
<script src="setting.js"></script>
<script>
    function toggleMenu() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
    }

    // Основная функция инициализации
    document.addEventListener('DOMContentLoaded', async function() {
        // Загрузка пользователей при открытии страницы
        await loadUsers();

        // Инициализация функционала таблицы
        initUserTable();
    });

    // Загрузка пользователей с сервера
    async function loadUsers() {
        try {
            const institutionKey = localStorage.getItem('institutionKey');
            if (!institutionKey) {
                alert('Отсутствует ключ учреждения. Повторите вход.');
                window.location.href = 'login.html';
                return;
            }

            const response = await fetch('/api/v1/institutions', {
                method: 'GET',
                headers: {
                    'Authorization': institutionKey
                }
            });

            if (!response.ok) {
                throw new Error('Ошибка загрузки пользователей');
            }

            const users = await response.json();
            renderUsers(users);
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Не удалось загрузить пользователей: ' + error.message);
        }
    }

    // Отрисовка пользователей в таблице
    function renderUsers(users) {
        const tbody = document.querySelector('.users-table tbody');
        tbody.innerHTML = ''; // Очищаем таблицу

        users.forEach((user, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${user.key}</td>
                <td>${user.name || ''}</td>
                <td>${user.login || ''}</td>
                <td>••••••••</td>
                <td>
                    <button class="action-button delete">Удалить</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        // После рендеринга добавляем обработчики для кнопок
        addDeleteHandlers();
    }

    // Добавление обработчиков для кнопок удаления
    function addDeleteHandlers() {
        document.querySelectorAll('.action-button.delete').forEach(btn => {
            btn.addEventListener('click', async function() {
                const row = this.closest('tr');
                const keyCell = row.querySelector('td:nth-child(2)'); // Ячейка с ключом
                const userKey = keyCell.textContent;

                if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                    try {
                        await deleteUser(userKey);
                        await loadUsers(); // Перезагружаем список после удаления
                    } catch (error) {
                        console.error('Ошибка удаления:', error);
                        alert(`Не удалось удалить пользователя: ${error.message}`);
                    }
                }
            });
        });
    }

    // Функция удаления пользователя
    async function deleteUser(userKey) {
        const institutionKey = localStorage.getItem('institutionKey'); // Получаем ключ авторизации

        // Проверяем, если ключ авторизации отсутствует
        if (!institutionKey) {
            alert('Отсутствует ключ авторизации. Пожалуйста, войдите в систему.');
            window.location.href = 'login.html'; // Перенаправляем на страницу входа
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/v1/institutions/delete_institution/${userKey}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': institutionKey, // Передаем ключ авторизации в заголовке
                }
            });

            if (!response.ok) {
                throw new Error('Ошибка при удалении пользователя');
            }

            await loadUsers(); // Перезагружаем список пользователей после успешного удаления
        } catch (error) {
            console.error('Ошибка удаления:', error);
            alert('Не удалось удалить пользователя: ' + error.message);
        }
    }

    // В обработчике модального окна подтверждения
    const confirmModal = document.getElementById('confirm-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    let currentAction = null;

    cancelDeleteBtn.addEventListener('click', function() {
        confirmModal.classList.remove('active');
    });

    confirmDeleteBtn.addEventListener('click', async function() {
        confirmModal.classList.remove('active');

        try {
            if (currentAction === 'delete-selected') {
                // Удаление выбранных пользователей
                const selectedKeys = [];
                document.querySelectorAll('.user-checkbox:checked').forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const keyCell = row.querySelector('td:nth-child(3)'); // Ячейка с ключом
                    selectedKeys.push(keyCell.textContent);
                });

                // Удаление выбранных пользователей
                for (const key of selectedKeys) {
                    await deleteUser(key);
                }

                // Перезагружаем список пользователей
                await loadUsers();
            } else if (currentAction === 'delete-all') {
                // Удаление всех пользователей через отдельный endpoint
                const response = await fetch('/api/v1/institutions/delete_all_institution', {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Ошибка при массовом удалении');
                }

                // Перезагружаем список пользователей
                await loadUsers();
            }
        } catch (error) {
            console.error('Ошибка удаления:', error);
            alert(`Ошибка при удалении: ${error.message}`);
        }
    });

    // Функция выхода
    function logout() {
        // Очищаем все данные авторизации
        localStorage.removeItem('institutionKey');
        localStorage.removeItem('institutionName');

        // Перенаправляем на страницу входа
        window.location.href = 'login.html';
    }
</script>
</body>
</html>
