<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - OPAC-Global</title>
    <link rel="stylesheet" href="styles.css" id="main-style">
    <link rel="stylesheet" href="light-styles.css" id="light-theme" disabled>
    <link rel="stylesheet" href="high-contrast.css">
    <link rel="stylesheet" href="grayscale.css">
</head>
<body>
<div class="container">
    <nav class="sidebar" id="sidebar">
        <ul class="menu">
            <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="marking.html">–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞</a></li>
            <li><a href="inventory.html">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</a></li>
            <li><a href="personnel.html">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∏</a></li>
            <li><a href="setting.html">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
            <li><a href="login.html">–í—ã—Ö–æ–¥</a></li>
            <li>
                <button id="theme-toggle" class="theme-toggle">
                    <span class="theme-icon">üåì</span> –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
                </button>
            </li>
        </ul>
    </nav>

    <button class="menu-button" onclick="toggleMenu()">‚ò∞</button>

    <main class="content">
        <div class="header">
            <h1>–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h1>
            <p>–°–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã</p>
        </div>

         <div class="users-table-container">
             <!--          <div class="bulk-actions">
                      <button id="select-all" class="select-all-button">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                      <button id="delete-selected" class="delete-selected-button" disabled>
                          –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (<span id="selected-count">0</span>)
                      </button>
                      <button id="delete-all" class="delete-all-button">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
                  </div> -->

                  <table class="users-table">
                      <thead>
                      <tr>
                          <th width="40px"></th>
                          <th>‚Ññ</th>
                          <th>ID</th>
                          <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                          <th>–õ–æ–≥–∏–Ω</th>
                          <th>–ü–∞—Ä–æ–ª—å</th>
                          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                      </thead>
                      <tbody id="users-table-body">
                      <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </tbody>
            </table>

            <div class="table-actions">
           <!--     <button class="add-user-button">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button> -->
                <button onclick="window.location.href='registration.html'">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </div>
        </div>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div class="modal-overlay" id="confirm-modal">
    <div class="modal-content">
        <h3 class="modal-title" id="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        <p class="modal-message" id="modal-message"></p>
        <div class="modal-actions">
            <button class="modal-button secondary" id="cancel-delete">–û—Ç–º–µ–Ω–∞</button>
            <button class="modal-button primary" id="confirm-delete">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>


<script src="theme-switcher.js"></script>
    <script>
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
            /*
            const userRole = localStorage.getItem('userRole');
            if (userRole !== 'admin') {
                alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω! –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤.');
                window.location.href = 'index.html';
                return;
            }
            */

            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            await loadUsers();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —Ç–∞–±–ª–∏—Ü—ã
            initUserTable();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
            document.querySelector('.add-user-button').addEventListener('click', function() {
                window.location.href = 'registration.html';
            });
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadUsers() {
            try {
                const response = await fetch('/api/v1/institutions');

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                }

                const users = await response.json();
                renderUsers(users);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ
        function renderUsers(users) {
            const tbody = document.querySelector('.users-table tbody');
            tbody.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É

            users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="user-checkbox" data-id="${user.id}"></td>
                    <td>${index + 1}</td>
                    <td>${user.key}</td>
                    <td class="editable" data-field="name">${user.name || ''}</td>

                    <td class="editable" data-field="username">${user.login || ''}</td>
                    <td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                    <td>
                        <button class="action-button edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="action-button delete">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
            addEditHandlers();
            addDeleteHandlers();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —Ç–∞–±–ª–∏—Ü—ã
        function initUserTable() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            const selectAllBtn = document.getElementById('select-all');
            const deleteSelectedBtn = document.getElementById('delete-selected');
            const deleteAllBtn = document.getElementById('delete-all');
            const selectedCount = document.getElementById('selected-count');
            const confirmModal = document.getElementById('confirm-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete');
            const confirmDeleteBtn = document.getElementById('confirm-delete');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');

            let currentAction = null;
            let selectedUsers = [];

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedUsers.push(this.getAttribute('data-id'));
                    } else {
                        selectedUsers = selectedUsers.filter(id => id !== this.getAttribute('data-id'));
                    }

                    updateSelectedCount();
                    selectAllBtn.textContent = selectedUsers.length === checkboxes.length ? '–°–Ω—è—Ç—å –≤—Å–µ' : '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
                });
            });

            // –ö–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
            selectAllBtn.addEventListener('click', function() {
                const allSelected = selectedUsers.length === checkboxes.length;

                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allSelected;

                    if (!allSelected && !selectedUsers.includes(checkbox.getAttribute('data-id'))) {
                        selectedUsers.push(checkbox.getAttribute('data-id'));
                    } else if (allSelected) {
                        selectedUsers = selectedUsers.filter(id => id !== checkbox.getAttribute('data-id'));
                    }
                });

                updateSelectedCount();
                this.textContent = !allSelected ? '–°–Ω—è—Ç—å –≤—Å–µ' : '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
            });

            // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ"
            deleteSelectedBtn.addEventListener('click', function() {
                if (selectedUsers.length === 0) return;

                currentAction = 'delete-selected';
                modalTitle.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è';
                modalMessage.textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedUsers.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?`;
                confirmModal.classList.add('active');
            });

            // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö"
            deleteAllBtn.addEventListener('click', function() {
                currentAction = 'delete-all';
                modalTitle.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è';
                modalMessage.textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?';
                confirmModal.classList.add('active');
            });

            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            cancelDeleteBtn.addEventListener('click', function() {
                confirmModal.classList.remove('active');
            });

            // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            confirmDeleteBtn.addEventListener('click', async function() {
                confirmModal.classList.remove('active');

                try {
                    if (currentAction === 'delete-selected') {
                        // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        for (const id of selectedUsers) {
                            await deleteUser(id);
                        }

                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        await loadUsers();

                    } else if (currentAction === 'delete-all') {
                        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        const response = await fetch('/api/v1/institutions');
                        const allUsers = await response.json();

                        // –£–¥–∞–ª—è–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ, –µ—Å–ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
                        for (const user of allUsers) {
                            if (user.id !== '1001') { // –ù–µ —É–¥–∞–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                                await deleteUser(user.id);
                            }
                        }

                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        await loadUsers();
                    }

                    // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
                    selectedUsers = [];
                    updateSelectedCount();
                    selectAllBtn.textContent = '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
                }
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            function updateSelectedCount() {
                selectedCount.textContent = selectedUsers.length;
                deleteSelectedBtn.disabled = selectedUsers.length === 0;
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function addEditHandlers() {
            document.querySelectorAll('.action-button.edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const userId = row.querySelector('.user-checkbox').getAttribute('data-id');
                    const isEditing = row.classList.contains('editing');

                    if (isEditing) {
                        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        saveUserChanges(row, userId);
                        this.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                        row.classList.remove('editing');
                    } else {
                        // –ù–∞—á–∞–ª–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        enableEditing(row);
                        this.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                        row.classList.add('editing');
                    }
                });
            });
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å—Ç—Ä–æ–∫–∏
        function enableEditing(row) {
            const editableCells = row.querySelectorAll('.editable');

            editableCells.forEach(cell => {
                const field = cell.getAttribute('data-field');
                const value = cell.textContent;

                cell.innerHTML = `<input type="text" value="${value}" data-field="${field}">`;
            });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function saveUserChanges(row, userId) {
            const inputs = row.querySelectorAll('input[data-field]');
            const userData = { id: userId };

            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                userData[field] = input.value;

                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —è—á–µ–π–∫—É –≤ –æ–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const cell = input.closest('td');
                cell.textContent = input.value;
                cell.setAttribute('data-field', field);
            });

            try {
                const response = await fetch('/api/v1/institutions/update_institution', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π');
                }

                const updatedUser = await response.json();
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω:', updatedUser);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è: ' + error.message);
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ
                await loadUsers();
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
        function addDeleteHandlers() {
            document.querySelectorAll('.action-button.delete').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const userId = this.closest('tr').querySelector('.user-checkbox').getAttribute('data-id');

                    if (userId === '1001') {
                        alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–∏—Å—Ç–µ–º—ã');
                        return;
                    }

                    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                        try {
                            await deleteUser(userId);
                            await loadUsers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
                        }
                    }
                });
            });
        }

       // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function deleteUser(userKey) {
        const response = await fetch(`/api/v1/institutions/delete_institution/${userKey}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }
    }

    // –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–∑–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é)
   confirmDeleteBtn.addEventListener('click', async function() {
        confirmModal.classList.remove('active');

        try {
            if (currentAction === 'delete-selected') {
                // –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const selectedKeys = [];
                document.querySelectorAll('.user-checkbox:checked').forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const keyCell = row.querySelector('td:nth-child(3)'); // –Ø—á–µ–π–∫–∞ —Å –∫–ª—é—á–æ–º
                    selectedKeys.push(keyCell.textContent);
                });

                // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                for (const key of selectedKeys) {
                    await deleteUser(key);
                }

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await loadUsers();

            } else if (currentAction === 'delete-all') {
                // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint
                const response = await fetch('/api/v1/institutions/delete_all_institution', {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏');
                }

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await loadUsers();
            }

            // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
            selectedUsers = [];
            updateSelectedCount();
            selectAllBtn.textContent = '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ${error.message}`);
        }
    });

    // –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è (–∑–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é)
    function addDeleteHandlers() {
        document.querySelectorAll('.action-button.delete').forEach(btn => {
            btn.addEventListener('click', async function() {
                const row = this.closest('tr');
                const keyCell = row.querySelector('td:nth-child(3)'); // –Ø—á–µ–π–∫–∞ —Å –∫–ª—é—á–æ–º
                const userKey = keyCell.textContent;

                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                    try {
                        await deleteUser(userKey);
                        await loadUsers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${error.message}`);
                    }
                }
            });
        });
    }
    </script>
</body>
</html>